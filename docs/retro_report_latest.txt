retro_report_latest.txt
======================

日期：2026-02-13（JST）
範圍：從「要把放不放得下加入種別 gating」→ 產出 Codex 規格 → 合併 PR → merge 後 PMR 爆炸 → 修復 → 完整跑通 PMR → 補齊 deterministic 的套用/commit 流程

----------------------------------------
1) 初始需求（產品/UX）
----------------------------------------
- 使用者確認「風格」= 首頁的表示スタイル（標準 / かわいい / 推し活用語），目前只有這三種。
- 想加入「放不放得下 / 置き場所」但只對需要的種別生效：
  - Physical（會多一個實體物）→ 要問
  - Non-physical（課金/門票/數位）→ 不問（skip）

設計原則：
- 問題要短、早出、決定性
- 並且要真的影響結論（至少避免在置き場所未定時推薦 BUY）
- 表示スタイル 只改文案，不改判定邏輯（降低風險）

----------------------------------------
2) 交付（給 Codex 的規格）
----------------------------------------
- 產出一份可直接貼給 Codex 的 PR prompt：
  - 新增 `storage_fit` 單選題（CONFIRMED / PROBABLE / NONE / UNKNOWN）
  - `shouldAskStorage(kindId)`：allowlist/skiplist
  - 對 physical kinds 生效；ticket/課金 skip
  - post-evaluation gate：
    - NONE/UNKNOWN：BUY -> THINK（保留），降低 confidence，附加 reason/action
    - PROBABLE：不一定改結論，但補 reason/action（先整理）
  - 結果頁顯示「置き場所」chip/row
  - 驗收：`npm run build` ✅ + dev 檢查 goods/ticket 行為

----------------------------------------
3) 合併 PR（功能落地）
----------------------------------------
- PR 內容（依 PR 描述）：
  - src/oshihapi/storageGate.ts：集中 shouldAskStorage + label
  - src/oshihapi/merch_v2_ja.ts：插入 q_storage_fit
  - src/oshihapi/modes/questionCopy.ts：三風格文案
  - app/flow/FlowClient.tsx：把 q_storage_fit 放進 early flow 並 condition filter
  - src/oshihapi/engine.ts：post gate（不改核心 scoring）
  - app/result/[runId]/page.tsx：結果顯示置き場所

----------------------------------------
4) merge 後 PMR 失敗（兩次）
----------------------------------------
4.1 第一次：stage=KILL_PORTS
- 現象：PMR 報錯「無法覆寫 PID 變數，因為它是唯讀或常數」
- 根因：PowerShell 變數大小寫不分；腳本使用 `$pid` 作自訂變數，等同在寫 `$PID`（內建唯讀）
- 解法：最小修補：把 `$pid` 改名為 `$owningPid`（保留語意、低風險）

4.2 第二次：stage=PARITY
- 現象：跑到 PARITY 時失敗
- 根因：同理；腳本使用 `$host` 作自訂變數，等同覆寫 `$Host`（內建唯讀）
- 解法：最小修補：把 `$host` 改名為 `$parityHost`（或 `$targetHost`）

結果：
- `.\post_merge_routine.ps1` 成功完整跑完
- parity 因缺 preview host 設定而 skipped（符合“不可阻斷 local”精神）
- local dev ready 並顯示 commitSha

----------------------------------------
5) 復盤重點：deterministic 與可診斷
----------------------------------------
(1) PowerShell 5.1 的「保留/唯讀變數」是高頻踩雷
- `$PID/$Host/$Args` 都不該被當作自訂變數名稱（即使小寫也會撞）

(2) `.Trim()` / `.ToString()` 在命令回傳空值時會炸
- DETACHED HEAD 時 `git symbolic-ref --short HEAD` 可能回傳空 → 不能直接 `.Trim()`

(3) 使用者實際操作容易「在 repo 外跑腳本」
- 所以任何「給我shell」都必須包含：
  - 自動 cd 到 repo root（或明確要求先 cd）
  - 失敗時清楚提示「你不在 repo」

----------------------------------------
6) 可重用 SOP（下次照抄）
----------------------------------------
A) merge 後驗收（唯一 SOP）
- `cd <repoRoot>`
- `.\post_merge_routine.ps1`

B) PMR 失敗時
- 先看 `stage:`（KILL_PORTS / NPM_CI / BUILD / PARITY / DEV_START）
- 打開 `ops/pmr_log_*.txt` 看第一個 error
- 需要協助就貼：
  - `=== PMR AUTO SUMMARY ===`
  - `ops/pmr_debug_bundle_*.zip` 路徑

C) DETACHED HEAD 自救
- `git branch --contains HEAD`
- `git switch <target-branch>`
- 再做 commit/push（不要在 detached 直接 commit）

----------------------------------------
7) 風險與影響範圍（本次）
----------------------------------------
- 功能面：新增「置き場所 gate」只影響 physical kinds 的流程與輸出（且是輸出層 gate，核心 scoring 不改）
- 運維面：PMR 被保留變數撞名卡死的風險已暴露，後續應加 “reserved var guard” 以 fail-fast
