# Codex PR 指令（急・中・長 + 結果UIの統合）

目的：
1) 結果ページを「刻度尺＋カード」で美化し、買う/保留/やめるが一瞬で分かるUIにする
2) 診断モードを「短（30秒）/中（~2分）/長（AIプロンプト生成）」の3段階として実装可能にする（MVPでは prompt を生成してコピーするだけ。外部API不要）
3) ML用の最小ログ（L1 + 行動ログ）を localStorage に保存（質問数は増やさない）

## 変更対象
- 追加：components/DecisionScale.tsx（3段スケール＋赤矢印）※すでにブランチにある前提
- 更新：app/result/[runId]/page.tsx（結果UI再構成、DecisionScale統合、コピーUX、L1）
- 更新：app/page.tsx（モードに “AIに相談する（長診断）” を追加。既存2モードは維持）
- 更新：app/flow/page.tsx（mode による出題の切替：short/medium/long）
- 追加 or 更新：src/oshihapi/promptBuilder.ts（長診断のAI prompt 生成）
- 必要なら更新：src/oshihapi/runStorage.ts / src/oshihapi/model.ts（RunRecord 拡張）

## 実装要件

### 1) モード（急・中・長）
- Home（app/page.tsx）に 3つ目の選択肢を追加：
  - 急いで決める（30秒）= short
  - じっくり決める（60秒〜2分）= medium
  - AIに相談する（長診断）= long
- /flow に mode を query param で渡す（既存の方式に合わせる）
- /flow で質問を選ぶ：
  - short: urgentCore のみ
  - medium: urgentCore + standard
  - long: urgentCore + standard + longOnly（自由入力含む）
- もし現状の題庫にフラグが不足していれば、最小の変更で追加する（質問数を増やさない・既存の日本語文言を崩さない）

### 2) 結果ページUI（app/result/[runId]/page.tsx）
- 画面順：
  A) 結論（買う/保留/やめる）＋短いサブコピー（説教しない）
  B) DecisionScale（decision + index）
  C) 今すぐやる（推奨行動 1〜3、ボタン/チェック）
  D) 理由（3〜6、カード表示）
  E) shareText（コピー＋トースト「コピーしました」）
  F) L1フィードバック（買った/保留/買わなかった/まだ）→ 保存

- DecisionScale の index（-1..+1）：
  - エンジン出力に連続スコアがあれば利用
  - 無ければ「総合点＋閾値」から正規化して導出（clamp）

### 3) 長診断：AI prompt 生成（外部APIなし）
- promptBuilder を作る：
  - 回答サマリー（α..p など）
  - 発火した交差項/非線形（例：αβ、γδ、max(0,γ-γ0)^2）
  - “次に確認すべき”チェックリスト
- 結果ページに「AIに相談する（プロンプトをコピー）」導線を追加（mode=long のとき優先表示。その他モードでも “もっと深掘り” として表示OK）

### 4) ML用ログ（localStorage）
- RunRecord に追加（存在しない場合）：
  - feedback_immediate: "bought"|"waited"|"not_bought"|"unknown"
  - behavior: time_total_ms, time_per_q_ms[], num_changes, num_backtracks, actions_clicked[]
- UI から保存できる helper（updateRun）を runStorage に追加

## 受け入れ基準
- npm run build が通る
- 結果ページがスマホで見やすい（DecisionScale + カード）
- コピーがワンタップででき、成功表示が出る
- long モードで AI prompt が生成でき、コピーできる
- L1 フィードバックが保存される
